{"version":3,"file":"index.umd.js","sources":["../src/HistoryContext.tsx","../src/SuspensePendingContext.tsx","../src/Router.tsx","../src/types.ts","../src/RouteDataContext.ts","../src/Routes.tsx","../src/BrowserRouter.tsx","../src/HashRouter.tsx","../src/LazyFetcher.ts","../src/MemoryRouter.tsx"],"sourcesContent":["import React, { createContext, useContext } from 'react';\n\nimport { History } from './types';\n\nconst HistoryContext = createContext<History | null>(null);\n\ntype Props = {\n  history: History;\n};\n\nexport const HistoryProvider: React.FC<Props> = ({\n  history,\n  children,\n}) => (\n  <HistoryContext.Provider value={history}>\n    {children}\n  </HistoryContext.Provider>\n);\n\nexport const useHistory = () => {\n  const history = useContext(HistoryContext);\n  if (!history) throw new Error('missing <HistoryContext>');\n  return history;\n};\n","import React, { createContext, useContext } from 'react';\n\nconst SuspensePendingContext = createContext(false);\n\ntype Props = {\n  suspensePending: boolean;\n};\n\nexport const SuspensePendingProvider: React.FC<Props> = ({\n  suspensePending,\n  children,\n}) => (\n  <SuspensePendingContext.Provider value={suspensePending}>\n    {children}\n  </SuspensePendingContext.Provider>\n);\n\nexport const useSuspensePending = () => useContext(SuspensePendingContext);\n","// eslint-disable-next-line spaced-comment\n/// <reference types=\"react/experimental\" />\n\nimport React, {\n  TransitionStartFunction,\n  useRef,\n  useTransition,\n} from 'react';\n// eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n// @ts-ignore\nimport { Router as RouterOrig } from 'react-router';\n\nimport { History, HistoryEvent } from './types';\nimport { HistoryProvider } from './HistoryContext';\nimport { SuspensePendingProvider } from './SuspensePendingContext';\n\ntype Props = {\n  history: History;\n  timeout?: number;\n};\n\nconst wrapHistory = (startTransiton: TransitionStartFunction) => (history: History) => {\n  const listen = (listener: (e: HistoryEvent) => void) => {\n    const unlisten = history.listen((e: HistoryEvent) => {\n      startTransiton(() => {\n        listener(e);\n      });\n    });\n    return unlisten;\n  };\n  return { ...history, listen };\n};\n\nexport const Router: React.FC<Props> = ({\n  history,\n  timeout = 2000,\n  children,\n}) => {\n  const [startTransiton, isPending] = useTransition({ timeoutMs: timeout });\n  const historyRef = useRef<History>();\n  if (!historyRef.current) {\n    historyRef.current = wrapHistory(startTransiton)(history);\n  }\n  return (\n    <HistoryProvider history={historyRef.current}>\n      <SuspensePendingProvider suspensePending={isPending}>\n        <RouterOrig history={historyRef.current} timeout={timeout}>\n          {children}\n        </RouterOrig>\n      </SuspensePendingProvider>\n    </HistoryProvider>\n  );\n};\n\nexport default Router;\n","import { ReactElement, ReactNode } from 'react';\n\ntype RouteWithElement = {\n  path: string;\n  element: ReactElement;\n  children: ReactNode;\n};\n\ntype RouteWithRedirectTo = {\n  path: string;\n  redirectTo: string;\n};\n\nexport type Route = RouteWithElement | RouteWithRedirectTo;\n\nexport const hasRouteElement = (route: Route): route is RouteWithElement => (\n  !!(route as RouteWithElement).element\n);\n\nexport type match<Params extends { [K in keyof Params]?: string } = {}> = {\n  params: Params;\n  pathname: string;\n};\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type History = any;\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type HistoryEvent = any;\n","/* eslint camelcase: off */\n/* eslint @typescript-eslint/camelcase: off */\n\nimport { createContainer } from 'react-tracked';\n\nconst passDataProp = ({ data }: { data: object }) => [\n  data,\n  null, // we don't use useUpdate\n] as const;\n\nconst {\n  Provider,\n  useTrackedState,\n  useSelector,\n} = createContainer(passDataProp);\n\nexport const RouteDataProvider = Provider;\n\ntype UseTrackedState = <State>(opts: {\n  unstable_ignoreStateEquality?: boolean;\n}) => State;\n\nexport const useRouteData = () => (useTrackedState as UseTrackedState)({\n  // Because Suspendable by react-suspense-fetch is a mutable object,\n  // we need this special mode to handle it.\n  unstable_ignoreStateEquality: true,\n});\n\nexport const useRouteDataSelector = useSelector;\n","/* eslint react/no-children-prop: off */\n\nimport React, { useEffect, useState, useRef } from 'react';\nimport {\n  useParams,\n  useResolvedLocation,\n  createRoutesFromChildren,\n  useRoutes as useRoutesOrig,\n  useLocation,\n  matchRoutes,\n  // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n  // @ts-ignore\n} from 'react-router';\n\nimport {\n  Route,\n  hasRouteElement,\n  match as Match,\n  HistoryEvent,\n} from './types';\nimport { useHistory } from './HistoryContext';\nimport { RouteDataProvider } from './RouteDataContext';\n\n// HACK because RouteContext is not exported.\nconst EMPTY_PATHNAME = { pathname: null };\nconst usePathname = () => useResolvedLocation(EMPTY_PATHNAME).pathname;\n\nexport const useRoutes = (\n  routesOrig: Route[],\n  basenameOrig = '',\n  caseSensitive = false,\n) => {\n  const history = useHistory();\n  const parentPathname = usePathname();\n  const parentParams = useParams();\n  const initialLocation = useRef(useLocation());\n\n  const basename = basenameOrig\n    ? `${parentPathname}/${basenameOrig}`.replace(/\\/\\/+/g, '/')\n    : parentPathname;\n\n  const [routeDataMap, setRouteDataMap] = useState<{ [path: string]: object }>({});\n\n  const ref = useRef<{\n    routesOrig: Route[];\n    basename: string;\n    caseSensitive: boolean;\n    parentParams: { [key: string]: string };\n  }>();\n  useEffect(() => {\n    ref.current = {\n      routesOrig,\n      basename,\n      caseSensitive,\n      parentParams,\n    };\n  });\n\n  useEffect(() => {\n    const callback = ({ location }: HistoryEvent) => {\n      const matches = matchRoutes(\n        ref.current?.routesOrig,\n        location,\n        ref.current?.basename,\n        ref.current?.caseSensitive,\n      );\n      (matches || []).forEach((match: Match & { route?: Route }) => {\n        const { params, pathname, route } = match;\n        if (!route || !hasRouteElement(route)) return;\n        const { fetchData } = route.element.props;\n        if (!fetchData) return;\n        const m: Match = {\n          params: { ...ref.current?.parentParams, ...params },\n          pathname,\n        };\n        const routeData = fetchData(m);\n        setRouteDataMap((prev) => ({ ...prev, [route.path]: routeData }));\n      });\n    };\n    const unlisten = history.listen(callback);\n    callback({ location: initialLocation.current });\n    return unlisten;\n  }, [history]);\n\n  const routes = routesOrig.map((route) => {\n    if (!hasRouteElement(route)) return route;\n    const { fetchData } = route.element.props;\n    if (!fetchData) return route;\n    const routeData = routeDataMap[route.path] as object | undefined;\n    return {\n      ...route,\n      element: routeData && (\n        <RouteDataProvider data={routeData} children={route.element} />\n      ),\n    };\n  });\n\n  return useRoutesOrig(routes, basenameOrig, caseSensitive);\n};\n\ntype Props = {\n  basename?: string;\n  caseSensitive?: boolean;\n};\n\nexport const Routes: React.FC<Props> = ({\n  basename = '',\n  caseSensitive = false,\n  children,\n}) => {\n  const routes = createRoutesFromChildren(children);\n  return useRoutes(routes, basename, caseSensitive);\n};\n","import React, { useRef } from 'react';\n// eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n// @ts-ignore\nimport { createBrowserHistory } from 'history';\n\nimport { Router } from './Router';\nimport { History } from './types';\n\ntype Props = {\n  window?: unknown;\n  timeout?: number;\n};\n\nexport const BrowserRouter: React.FC<Props> = ({\n  window,\n  timeout,\n  children,\n}) => {\n  const history = useRef<History>();\n  if (!history.current) {\n    history.current = createBrowserHistory({ window });\n  }\n  return (\n    <Router history={history.current} timeout={timeout}>\n      {children}\n    </Router>\n  );\n};\n\nexport default BrowserRouter;\n","import React, { useRef } from 'react';\n// eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n// @ts-ignore\nimport { createHashHistory } from 'history';\n\nimport { Router } from './Router';\nimport { History } from './types';\n\ntype Props = {\n  window?: unknown;\n  timeout?: number;\n};\n\nexport const HashRouter: React.FC<Props> = ({\n  window,\n  timeout,\n  children,\n}) => {\n  const history = useRef<History>();\n  if (!history.current) {\n    history.current = createHashHistory({ window });\n  }\n  return (\n    <Router history={history.current} timeout={timeout}>\n      {children}\n    </Router>\n  );\n};\n\nexport default HashRouter;\n","import { prepare, run, prefetch } from 'react-suspense-fetch';\n\nimport { match as Match } from './types';\n\nexport const LazyFetcher = <T extends object, P>(\n  factory: () => Promise<{ default: (m: Match<P>) => Promise<T> }>,\n) => {\n  const preparedFetcher = prepare(factory);\n  const invokeFetcher = async (\n    [fetcher, match]: readonly [(m: Match<P>) => Promise<T>, Match<P>],\n  ) => fetcher(match);\n  return (match: Match<P>) => {\n    run(preparedFetcher, null);\n    return prefetch(\n      invokeFetcher,\n      [preparedFetcher, match] as const,\n      (source) => [\n        source[0].default, // can suspend\n        source[1],\n      ] as const,\n    );\n  };\n};\n\nexport default LazyFetcher;\n","import React, { useRef } from 'react';\n// eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n// @ts-ignore\nimport { createMemoryHistory } from 'history';\n\nimport { Router } from './Router';\nimport { History } from './types';\n\ntype Props = {\n  initialEntries: number;\n  initialIndex: number;\n  timeout?: number;\n};\n\nexport const MemoryRouter: React.FC<Props> = ({\n  initialEntries,\n  initialIndex,\n  timeout,\n  children,\n}) => {\n  const history = useRef<History>();\n  if (!history.current) {\n    history.current = createMemoryHistory({ initialEntries, initialIndex });\n  }\n  return (\n    <Router history={history.current} timeout={timeout}>\n      {children}\n    </Router>\n  );\n};\n\nexport default MemoryRouter;\n"],"names":["HistoryContext","createContext","HistoryProvider","React","Provider","value","history","children","SuspensePendingContext","SuspensePendingProvider","suspensePending","Router","timeout","useTransition","timeoutMs","startTransiton","isPending","historyRef","useRef","current","listen","listener","e","wrapHistory","RouterOrig","hasRouteElement","route","element","createContainer","data","useTrackedState","RouteDataProvider","useRouteDataSelector","useSelector","EMPTY_PATHNAME","pathname","useRoutes","routesOrig","basenameOrig","caseSensitive","useContext","Error","useHistory","parentPathname","useResolvedLocation","parentParams","useParams","initialLocation","useLocation","basename","replace","useState","routeDataMap","setRouteDataMap","ref","useEffect","callback","matchRoutes","_ref$current","location","_ref$current2","_ref$current3","forEach","match","params","fetchData","props","routeData","_ref$current4","prev","path","unlisten","routes","map","useRoutesOrig","window","createBrowserHistory","createHashHistory","factory","preparedFetcher","prepare","invokeFetcher","fetcher","run","prefetch","source","initialEntries","initialIndex","createMemoryHistory","createRoutesFromChildren","unstable_ignoreStateEquality"],"mappings":"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"}